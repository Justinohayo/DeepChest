<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Book Appointment - DeepChest</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/admin.css" />
    <link rel="stylesheet" href="/static/logostyle.css" />
  </head>
  <body>
    <nav>
      <div class="logo">
        <a href="/admin_home">
          <img src="{{ url_for('static', filename='logo_DeepChest.png') }}" class="logo-img" />
        </a>
        <div class="logo-text">DeepChest</div>
      </div>
      <div class="nav-links">
        <a href="/admin_home">Home</a>
        <a href="/admin_home/appointments">Appointments</a>
        <a href="/clinic_admin/ManageAccount">Manage Account</a>
        <a href="/clinic_admin/ManageReports">Manage Report</a>
        <a href="/logout">Logout</a>
      </div>
    </nav>
    {# Show Flask flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="admin-content">
      <h1>Book Appointment</h1>
      <div class="booking-grid">
        <div class="calendar-panel">
          <h3>SELECT DATE</h3>
          <div id="calendar" class="calendar-container"></div>
        </div>

        <div class="info-panel">
          <h3>APPOINTMENT INFO</h3>
          <form id="book-form" method="POST" action="{{ url_for('admin_book_appointment') }}">
            <div class="form-row">
              <label class="book-form-label">Patient: *</label>
              <select name="patient_id" id="patient-select" class="book-form-input" required>
                <option value="">-- Select Patient --</option>
                {% for patient in patients %}
                  <option value="{{ patient.USERID }}">{{ patient.firstName }} {{ patient.lastName }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-row">
              <label class="book-form-label">Doctor: *</label>
              <select name="doctor_id" id="doctor-select" class="book-form-input" required>
                <option value="">-- Select Doctor --</option>
                {% for doctor in doctors %}
                  <option value="{{ doctor.USERID }}">{{ doctor.firstName }} {{ doctor.lastName }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-row">
              <label class="book-form-label">Date: *</label>
              <input type="text" id="selected-date" name="appointment_date" readonly class="book-form-input" placeholder="Select a date from calendar" required />
            </div>

            <div class="form-row">
              <label class="book-form-label">Time: *</label>
              <div id="timeslots" class="timeslots"></div>
              <input type="hidden" id="selected-time" name="appointment_time" />
            </div>

            <div class="form-row">
              <label class="book-form-label">Symptoms:</label>
              <textarea name="symptoms" id="symptoms" rows="4" class="book-form-textarea" placeholder="Enter patient symptoms or reason for visit"></textarea>
            </div>

            <div class="form-row form-actions">
              <button type="submit" id="book-btn" class="book-btn">Book Appointment</button>
              <a href="{{ url_for('admin_appointmennts') }}" class="book-btn" style="background:#aaa; text-decoration:none; display:inline-block;">Cancel</a>
            </div>
          </form>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', ()=>{
          const times = ['09:00:00','09:30:00','10:00:00','10:30:00','11:00:00','11:30:00','13:00:00','13:30:00','14:00:00','14:30:00','15:00:00','15:30:00'];
          const timeslotsEl = document.getElementById('timeslots');
          const selectedTimeInput = document.getElementById('selected-time');
          const selectedDateInput = document.getElementById('selected-date');
          const doctorSelect = document.getElementById('doctor-select');

          function renderTimeSlots() {
            timeslotsEl.innerHTML = '';
            times.forEach(t => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'timeslot-btn';
              btn.textContent = t.slice(0,5);
              btn.addEventListener('click', () => {
                document.querySelectorAll('.timeslot-btn').forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedTimeInput.value = t;
              });
              timeslotsEl.appendChild(btn);
            });
          }

          function buildCalendar(container) {
            const today = new Date();
            let month = today.getMonth();
            let year = today.getFullYear();

            function render() {
              container.innerHTML = '';
              const header = document.createElement('div');
              header.className = 'calendar-header';
              const monthName = new Date(year, month, 1).toLocaleString('default',{month:'long'});
              header.innerHTML = `<button id="prev-month">&lt;</button> <strong>${monthName} ${year}</strong> <button id="next-month">&gt;</button>`;
              container.appendChild(header);

              const table = document.createElement('table');
              table.className = 'calendar-table';
              const days = ['Su','Mo','Tu','We','Th','Fr','Sa'];
              const thead = document.createElement('thead');
              thead.innerHTML = '<tr>' + days.map(d=>`<th>${d}</th>`).join('') + '</tr>';
              table.appendChild(thead);

              const first = new Date(year, month, 1);
              const startDay = first.getDay();
              const daysInMonth = new Date(year, month+1, 0).getDate();

              const tbody = document.createElement('tbody');
              let row = document.createElement('tr');
              for(let i=0;i<startDay;i++) row.innerHTML += '<td></td>';
              for(let d=1; d<=daysInMonth; d++){
                if(row.children.length===7){ tbody.appendChild(row); row=document.createElement('tr'); }
                const cell = document.createElement('td');
                cell.className = 'calendar-cell';
                cell.textContent = d;
                const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                cell.addEventListener('click', ()=>{
                  document.querySelectorAll('.calendar-cell').forEach(c=>c.classList.remove('selected'));
                  cell.classList.add('selected');
                  selectedDateInput.value = iso;
                  selectedTimeInput.value = '';
                  document.querySelectorAll('.timeslot-btn').forEach(b=>{b.classList.remove('selected'); b.disabled = false; b.classList.remove('disabled');});
                  
                  // Fetch booked times for selected doctor and date
                  const doctorId = doctorSelect.value;
                  if(doctorId && iso) {
                    fetch(`/admin/booked_times?doctor_id=${doctorId}&date=${iso}`)
                      .then(r=>r.text())
                      .then(text=>{
                        const booked = text ? text.split(',') : [];
                        document.querySelectorAll('.timeslot-btn').forEach(b=>{
                          const tt = b.textContent.trim();
                          const ttss = tt + ':00';
                          if(booked.includes(ttss)){
                            b.disabled = true;
                            b.classList.add('disabled');
                          }
                        });
                      }).catch(()=>{});
                  }
                });
                row.appendChild(cell);
              }
              while(row.children.length<7) row.innerHTML += '<td></td>';
              tbody.appendChild(row);
              table.appendChild(tbody);
              container.appendChild(table);

              header.querySelector('#prev-month').addEventListener('click', ()=>{ month = month-1; if(month<0){ month=11; year--; } render(); });
              header.querySelector('#next-month').addEventListener('click', ()=>{ month = month+1; if(month>11){ month=0; year++; } render(); });
            }
            render();
          }

          renderTimeSlots();
          buildCalendar(document.getElementById('calendar'));

          // When doctor changes, refresh timeslots if date is selected
          doctorSelect.addEventListener('change', ()=>{
            const dateVal = selectedDateInput.value;
            const doctorId = doctorSelect.value;
            if(dateVal && doctorId) {
              selectedTimeInput.value = '';
              document.querySelectorAll('.timeslot-btn').forEach(b=>{b.classList.remove('selected'); b.disabled = false; b.classList.remove('disabled');});
              fetch(`/admin/booked_times?doctor_id=${doctorId}&date=${dateVal}`)
                .then(r=>r.text())
                .then(text=>{
                  const booked = text ? text.split(',') : [];
                  document.querySelectorAll('.timeslot-btn').forEach(b=>{
                    const tt = b.textContent.trim();
                    const ttss = tt + ':00';
                    if(booked.includes(ttss)){
                      b.disabled = true;
                      b.classList.add('disabled');
                    }
                  });
                }).catch(()=>{});
            }
          });

          // Client-side validation
          const form = document.getElementById('book-form');
          form.addEventListener('submit', (e)=>{
            const patientVal = document.getElementById('patient-select').value;
            const doctorVal = document.getElementById('doctor-select').value;
            const dateVal = document.getElementById('selected-date').value;
            const timeVal = document.getElementById('selected-time').value;
            if(!patientVal || !doctorVal || !dateVal || !timeVal){
              e.preventDefault();
              alert('Please fill in all required fields: Patient, Doctor, Date, and Time.');
            }
          });
        });
      </script>
    </div>
  </body>
</html>
