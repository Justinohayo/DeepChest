<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Clinic Admin Report Management - DeepChest</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/admin.css"/>
    <link rel="stylesheet" href="/static/logostyle.css" />
  </head>
  <body>
    <nav>
      <div class="logo">
        <a href="/admin_home"><img src="{{ url_for('static', filename='logo_DeepChest.png') }}" class="logo-img"/></a>
        <div class="logo-text">DeepChest</div>
      </div>
      <div class="nav-links">
        <a href="/admin_home">Home</a>
        <a href="/admin/appointments">Appointments</a>
        <a href="/admin/ManageAccount">Manage Accounts</a>
        <a href="/admin/manage_reports">Manage Reports</a>
        <div class="dropdown">
          <button class="dropbtn">Account &#9662;</button>
          <div class="dropdown-content">
            <a href="/admin/manage_clinic">Manage Clinic</a>
            <a href="/logout">Logout</a>
          </div>
        </div>
      </div>
    </nav>
    <div class="admin-content">
      <h1>Manage All Reports</h1>
      <p>View and manage all diagnostic reports for your clinic.</p>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-container">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Cleanup Button -->
      <div style="margin-bottom: 20px; text-align: center;">
        <form method="POST" action="/admin/cleanup_expired_reports" style="display: inline;">
          <button type="submit" class="appt-action-btn" onclick="return confirm('This will permanently delete all expired reports. Continue?');">
             Remove Expired Reports
          </button>
        </form>
      </div>

      <!-- Search Bar and Filter -->
      <div class="search-filter">
        <form method="GET" action="/admin/search_reports" style="display: flex; gap: 16px; align-items: center;">
          <input
            type="text"
            name="query"
            class="report-search-bar"
            placeholder="Search for specific reports..."
            autocomplete="off"
            value="{{ query if query else '' }}"
          />
          <select name="filter" class="filter-select" onchange="this.form.submit()">
            <option value="newest" {% if filter_by == 'newest' %}selected{% endif %}>Newest First</option>
            <option value="oldest" {% if filter_by == 'oldest' %}selected{% endif %}>Oldest First</option>
            <option value="expiry" {% if filter_by == 'expiry' %}selected{% endif %}>Expiry Date</option>
          </select>
          <button type="submit" class="report-search-btn">Search</button>
        </form>
      </div>

      <!-- Reports Table -->
      <div class="admin-reports-table">
        <table class="search-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Expiry Date</th>
              <th>Patient Name</th>
              <th>Doctor Name</th>
              <th>File</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if reports %}
              {% for r in reports %}
              <tr>
                <td>
                  {{ r.reportDate.strftime('%B %#d %Y') if r.reportDate else '' }}
                </td>
                <td>
                  {{ r.expiryDate.strftime('%B %#d %Y') if r.expiryDate else 'N/A' }}
                </td>
                <td>
                  {% if r.patientFirstName and r.patientLastName %}
                    {{ r.patientFirstName }} {{ r.patientLastName }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if r.doctorFirstName and r.doctorLastName %}
                    {{ r.doctorFirstName }} {{ r.doctorLastName }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if r.files %}
                    <a
                      href="/static/uploads/{{ r.files }}"
                      class="file-link"
                      target="_blank"
                      >{{ r.files }}</a
                    >
                  {% else %}
                    <em>No file uploaded</em>
                  {% endif %}
                </td>
                <td>
                  {% if r.files %}
                    <a href="/static/uploads/{{ r.files }}" class="manage-btn" target="_blank">View</a>
                  {% else %}
                    <span class="manage-btn" style="opacity: 0.4; cursor: not-allowed;">View</span>
                  {% endif %}
                  <form method="POST" action="/admin/delete_report" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this report?');">
                    <input type="hidden" name="reportID" value="{{ r.reportID }}" />
                    <button type="submit" class="delete-btn">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" style="text-align: center;">No reports found.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </body>
</html>
