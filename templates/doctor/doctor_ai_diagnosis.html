<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Diagnosis - DeepChest</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/logostyle.css" />
    <link rel="stylesheet" href="/static/doctor.css" />
    <style>
      .ai-container {
        display: flex;
        gap: 20px;
        margin: 20px;
        flex-wrap: wrap;
      }
      .top-section {
        display: flex;
        gap: 20px;
        width: 100%;
      }
      .upload-box, .result-box {
        flex: 1;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 12px;
        background: #f9f9f9;
      }
      .upload-box h2, .result-box h2 {
        margin-bottom: 15px;
      }
      .report-generation-box {
        width: 100%;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 12px;
        background: #f9f9f9;
        display: none; /* Hidden by default */
      }
      .report-generation-box.show {
        display: block;
      }
      .report-generation-box h2 {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="logo">
        <a href="/"
          ><img
            src="{{ url_for('static', filename='logo_DeepChest.png') }}"
            class="logo-img"
        /></a>
        <div class="logo-text">DeepChest</div>
      </div>
      <div class="nav-links">
        <a href="/doctor_home">Home</a>
        <a href="/doctor/appointments">Appointments</a>
        <a href="/doctor/patients">My Patients</a>
        <a href="/doctor/reports">Reports</a>
        <a href="#">AI Diagnosis</a>
        <div class="dropdown">
          <button class="dropbtn">Account &#9662;</button>
          <div class="dropdown-content">
            <a href="/doctor/account">Manage Account</a>
            <a href="/logout">Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="doctor-page-content">
      <h1>AI Diagnosis</h1>
      <p>Upload scans to get AI-powered analysis here.</p>

      <div class="ai-container">
        <!-- Top Section: Upload and Results side by side -->
        <div class="top-section">
          <!-- Upload Box -->
          <div class="upload-box">
            <h2>Upload X-Ray</h2>
            <form action="{{ url_for('doctor_ai_diagnosis') }}" method="post" enctype="multipart/form-data">
              <input type="text" name="patient_name" placeholder="Patient Name" required /><br><br>
              <input type="file" name="xray" accept="image/*" required><br><br>
              <button type="submit">Analyze</button>
            </form>
          </div>

          <!-- Result Box -->
          <div class="result-box">
            <h2>Prediction Report</h2>
            {% if gradcam_b64 %}
              <p><strong>Patient Name:</strong> {{patient_name}}</p>
              <p><strong>Predicted Condition:</strong> {{ prediction.label }} ({{'%.1f'|format(prediction.prob)}}%)</p>
              
              <h3>All Probabilities:</h3>
              <ul style="list-style-type: none; padding-left: 0;">
                {% for condition, prob in prediction.probs %}
                  <li>{{ condition }}: {{'%.1f'|format(prob)}}%</li>
                {% endfor %}
              </ul>
              
              <h3>Grad-CAM Visualization:</h3>
              <img src="data:image/png;base64,{{ gradcam_b64 }}" alt="Grad-CAM Heatmap" style="max-width: 100%; height: auto;"><br><br>
            {% else %}
              <p>No analysis yet. Please upload an X-ray.</p>
            {% endif %}
          </div>
        </div>
        
        <!-- Report Generation Box (appears after prediction) -->
        <div class="report-generation-box {% if gradcam_b64 %}show{% endif %}">
          <h2>Generate Report</h2>
          <form action="{{url_for('doctor_report_generation')}}" method="post" target="blank">
            <input type="hidden" name="patient_id" value="{{patient_id }}">
            <input type="hidden" name="xray_data" value="{{ file }}">
            <input type="hidden" name="patient_name" value="{{ patient_name }}">
            <label for="doctor_note">Doctor's Note:</label><br>
            <textarea name="doctor_note" rows="4" cols="50" required></textarea><br><br>
            <button type="submit" name="generate_report">Generate PDF Report</button>
          </form>
        </div>
        
      </div>
    </div>
    
  </body>
</html>
