<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Patient Book Appointments- DeepChest</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/patient.css" />
    <link rel="stylesheet" href="/static/logostyle.css" />
  </head>
  <body>
    <nav>
      <div class="logo">
        <a href="/patient_home"
          ><img
            src="{{ url_for('static', filename='logo_DeepChest.png') }}"
            class="logo-img"
        /></a>
        <div class="logo-text">DeepChest</div>
      </div>
      <div class="nav-links">
        <a href="/patient_home">Home</a>
        <a href="/patient/appointments">Appointments</a>
       <!--<a href="/patient/reports">My Reports</a> -->
        <a href="/patient/messages">Message</a>
        <div class="dropdown">
          <button class="dropbtn">Account &#9662;</button>
          <div class="dropdown-content">
            <a href="/patient/account">Manage Account</a>
            <a href="/logout">Logout</a>
          </div>
        </div>
      </div>
    </nav>
    <div class="patient-content">
      <h1>Book your appointments with ease.</h1>
      <div class="booking-grid">
        <div class="calendar-panel">
          <h3>APPOINTMENTS LIST</h3>
          <div id="calendar" class="calendar-container" data-existing-dates="{{ (existing_appointments|default([]))|join(',') }}"></div>
        </div>

        <div class="info-panel">
          <h3>APPOINTMENT INFO</h3>
          <form id="book-form" method="POST" action="{{ url_for('patient_book_appointment') }}">
            <div class="form-row"><label class="book-form-label">Date:</label>
              <input type="text" id="selected-date" name="appointment_date" readonly class="book-form-input" placeholder="Select a date from calendar" />
            </div>

            <div class="form-row"><label class="book-form-label">Time:</label>
              <div id="timeslots" class="timeslots"></div>
              <input type="hidden" id="selected-time" name="appointment_time" />
            </div>

            <div class="form-row"><label class="book-form-label">Symptoms:</label>
              <textarea name="symptoms" id="symptoms" rows="4" class="book-form-textarea"></textarea>
            </div>

            <div class="form-row form-actions">
              <button type="submit" id="book-btn" class="book-btn">Book Appointment</button>
            </div>
          </form>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', ()=>{
          // Existing appointment dates passed via data attribute
          const existingDates = document.getElementById('calendar').dataset.existingDates ? document.getElementById('calendar').dataset.existingDates.split(',') : [];
          // Simple calendar + timeslot UI
          const times = ['09:00:00','09:30:00','10:00:00','10:30:00','11:00:00','11:30:00','13:00:00','13:30:00','14:00:00','14:30:00','15:00:00','15:30:00'];
          const timeslotsEl = document.getElementById('timeslots');
          const selectedTimeInput = document.getElementById('selected-time');
          const selectedDateInput = document.getElementById('selected-date');

          function renderTimeSlots() {
            timeslotsEl.innerHTML = '';
            times.forEach(t => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'timeslot-btn';
              btn.textContent = t.slice(0,5);
              btn.addEventListener('click', () => {
                document.querySelectorAll('.timeslot-btn').forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedTimeInput.value = t;
              });
              timeslotsEl.appendChild(btn);
            });
          }

          // Basic month calendar
          function buildCalendar(container) {
            const today = new Date();
            let month = today.getMonth();
            let year = today.getFullYear();

            function render() {
              container.innerHTML = '';
              const header = document.createElement('div');
              header.className = 'calendar-header';
              const monthName = new Date(year, month, 1).toLocaleString('default',{month:'long'});
              header.innerHTML = `<button id="prev-month">&lt;</button> <strong>${monthName} ${year}</strong> <button id="next-month">&gt;</button>`;
              container.appendChild(header);

              const table = document.createElement('table');
              table.className = 'calendar-table';
              const days = ['Su','Mo','Tu','We','Th','Fr','Sa'];
              const thead = document.createElement('thead');
              thead.innerHTML = '<tr>' + days.map(d=>`<th>${d}</th>`).join('') + '</tr>';
              table.appendChild(thead);

              const first = new Date(year, month, 1);
              const startDay = first.getDay();
              const daysInMonth = new Date(year, month+1, 0).getDate();

              const tbody = document.createElement('tbody');
              let row = document.createElement('tr');
              // blanks
              for(let i=0;i<startDay;i++) row.innerHTML += '<td></td>';
              for(let d=1; d<=daysInMonth; d++){
                if(row.children.length===7){ tbody.appendChild(row); row=document.createElement('tr'); }
                const cell = document.createElement('td');
                cell.className = 'calendar-cell';
                cell.textContent = d;
                const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                // mark if has appointment
                if(existingDates.includes(iso)){
                  cell.classList.add('appointment-mark');
                }
                cell.addEventListener('click', ()=>{
                  // select date
                  selectedDateInput.value = iso;
                  // clear time selection
                  selectedTimeInput.value = '';
                  document.querySelectorAll('.timeslot-btn').forEach(b=>{b.classList.remove('selected'); b.disabled = false; b.classList.remove('disabled');});
                  // fetch booked times for this date and disable those timeslots
                  fetch(`/patient/booked_times?date=${iso}`)
                    .then(r=>{ if(!r.ok) return []; return r.json(); })
                    .then(booked=>{
                      document.querySelectorAll('.timeslot-btn').forEach(b=>{
                        const tt = b.textContent.trim();
                        const ttss = tt + ':00';
                        if(booked.includes(ttss)){
                          b.disabled = true;
                          b.classList.add('disabled');
                        }
                      });
                    }).catch(()=>{});
                });
                row.appendChild(cell);
              }
              // fill remaining
              while(row.children.length<7) row.innerHTML += '<td></td>';
              tbody.appendChild(row);
              table.appendChild(tbody);
              container.appendChild(table);

              // month nav
              header.querySelector('#prev-month').addEventListener('click', ()=>{ month = month-1; if(month<0){ month=11; year--; } render(); });
              header.querySelector('#next-month').addEventListener('click', ()=>{ month = month+1; if(month>11){ month=0; year++; } render(); });
            }
            render();
          }

          renderTimeSlots();
          buildCalendar(document.getElementById('calendar'));
          // client-side validation: ensure date+time selected before submit
          const form = document.getElementById('book-form');
          form.addEventListener('submit', (e)=>{
            const dateVal = document.getElementById('selected-date').value;
            const timeVal = document.getElementById('selected-time').value;
            if(!dateVal || !timeVal){
              e.preventDefault();
              alert('Please select a date and time before booking.');
            }
          });
        });
      </script>
    </div>
  </body>
</html>
